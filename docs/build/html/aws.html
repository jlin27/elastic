


<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>torchelastic on AWS &mdash; PyTorch/Elastic master documentation</title>
  

  
  
  
  

  

  
  
    

  

  <link rel="stylesheet" href="_static/css/theme.css" type="text/css" />
  <!-- <link rel="stylesheet" href="_static/pygments.css" type="text/css" /> -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.10.0-beta/dist/katex.min.css" type="text/css" />
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.11.1/dist/katex.min.css" type="text/css" />
  <link rel="stylesheet" href="_static/katex-math.css" type="text/css" />
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="torchelastic on Azure" href="azure.html" />
    <link rel="prev" title="PyTorch Elastic" href="overview.html" /> 

  
  <script src="_static/js/modernizr.min.js"></script>

  <!-- Preload the theme fonts -->

<link rel="preload" href="_static/fonts/FreightSans/freight-sans-book.woff2" as="font" type="font/woff2" crossorigin="anonymous">
<link rel="preload" href="_static/fonts/FreightSans/freight-sans-medium.woff2" as="font" type="font/woff2" crossorigin="anonymous">
<link rel="preload" href="_static/fonts/IBMPlexMono/IBMPlexMono-Medium.woff2" as="font" type="font/woff2" crossorigin="anonymous">
<link rel="preload" href="_static/fonts/FreightSans/freight-sans-bold.woff2" as="font" type="font/woff2" crossorigin="anonymous">
<link rel="preload" href="_static/fonts/FreightSans/freight-sans-medium-italic.woff2" as="font" type="font/woff2" crossorigin="anonymous">
<link rel="preload" href="_static/fonts/IBMPlexMono/IBMPlexMono-SemiBold.woff2" as="font" type="font/woff2" crossorigin="anonymous">

<!-- Preload the katex fonts -->

<link rel="preload" href="https://cdn.jsdelivr.net/npm/katex@0.10.0/dist/fonts/KaTeX_Math-Italic.woff2" as="font" type="font/woff2" crossorigin="anonymous">
<link rel="preload" href="https://cdn.jsdelivr.net/npm/katex@0.10.0/dist/fonts/KaTeX_Main-Regular.woff2" as="font" type="font/woff2" crossorigin="anonymous">
<link rel="preload" href="https://cdn.jsdelivr.net/npm/katex@0.10.0/dist/fonts/KaTeX_Main-Bold.woff2" as="font" type="font/woff2" crossorigin="anonymous">
<link rel="preload" href="https://cdn.jsdelivr.net/npm/katex@0.10.0/dist/fonts/KaTeX_Size1-Regular.woff2" as="font" type="font/woff2" crossorigin="anonymous">
<link rel="preload" href="https://cdn.jsdelivr.net/npm/katex@0.10.0/dist/fonts/KaTeX_Size4-Regular.woff2" as="font" type="font/woff2" crossorigin="anonymous">
<link rel="preload" href="https://cdn.jsdelivr.net/npm/katex@0.10.0/dist/fonts/KaTeX_Size2-Regular.woff2" as="font" type="font/woff2" crossorigin="anonymous">
<link rel="preload" href="https://cdn.jsdelivr.net/npm/katex@0.10.0/dist/fonts/KaTeX_Size3-Regular.woff2" as="font" type="font/woff2" crossorigin="anonymous">
<link rel="preload" href="https://cdn.jsdelivr.net/npm/katex@0.10.0/dist/fonts/KaTeX_Caligraphic-Regular.woff2" as="font" type="font/woff2" crossorigin="anonymous">
</head>

<div class="container-fluid header-holder tutorials-header" id="header-holder">
  <div class="container">
    <div class="header-container">
      <a class="header-logo" href="https://pytorch.org/" aria-label="PyTorch"></a>

      <div class="main-menu">
        <ul>
          <li>
            <a href="https://pytorch.org/get-started">Get Started</a>
          </li>

          <li>
            <div class="ecosystem-dropdown">
              <a id="dropdownMenuButton" data-toggle="ecosystem-dropdown">
                Ecosystem
              </a>
              <div class="ecosystem-dropdown-menu">
                <a class="nav-dropdown-item" href="https://pytorch.org/hub"">
                  <span class=dropdown-title>Models (Beta)</span>
                  <p>Discover, publish, and reuse pre-trained models</p>
                </a>
                <a class="nav-dropdown-item" href="https://pytorch.org/ecosystem">
                  <span class=dropdown-title>Tools & Libraries</span>
                  <p>Explore the ecosystem of tools and libraries</p>
                </a>
              </div>
            </div>
          </li>

          <li>
            <a href="https://pytorch.org/mobile">Mobile</a>
          </li>

          <li>
            <a href="https://pytorch.org/blog/">Blog</a>
          </li>

          <li>
            <a href="https://pytorch.org/tutorials">Tutorials</a>
          </li>

          <li>
            <a href="https://pytorch.org/docs/stable/index.html">Docs</a>
          </li>

          <li>
            <div class="resources-dropdown">
              <a id="resourcesDropdownButton" data-toggle="resources-dropdown">
                Resources
              </a>
              <div class="resources-dropdown-menu">
                <a class="nav-dropdown-item" href="https://pytorch.org/resources"">
                  <span class=dropdown-title>Developer Resources</span>
                  <p>Find resources and get questions answered</p>
                </a>
                <a class="nav-dropdown-item" href="https://pytorch.org/features">
                  <span class=dropdown-title>About</span>
                  <p>Learn about PyTorch’s features and capabilities</p>
                </a>
              </div>
            </div>
          </li>

          <li>
            <a href="https://github.com/pytorch/pytorch">Github</a>
          </li>
        </ul>
      </div>

      <a class="main-menu-open-button" href="#" data-behavior="open-mobile-menu"></a>
    </div>

  </div>
</div>


<body class="pytorch-body">

   

    

    <div class="table-of-contents-link-wrapper">
      <span>Table of Contents</span>
      <a href="#" class="toggle-table-of-contents" data-behavior="toggle-table-of-contents"></a>
    </div>

    <nav data-toggle="wy-nav-shift" class="pytorch-left-menu" id="pytorch-left-menu">
      <div class="pytorch-side-scroll">
        <div class="pytorch-menu pytorch-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          <div class="pytorch-left-menu-search">
            

            
              
              
                <div class="version">
                  master 
                </div>
              
            

            


  


<div role="search">
  <form id="rtd-search-form" class="wy-form" action="search.html" method="get">
    <input type="text" name="q" placeholder="Search Docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

            
          </div>

          
            
            
              
            
            
              <p class="caption"><span class="caption-text">Documentation</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="overview.html">PyTorch Elastic</a></li>
</ul>
<p class="caption"><span class="caption-text">Runtime</span></p>
<ul class="current">
<li class="toctree-l1 current"><a class="current reference internal" href="#">torchelastic on AWS</a></li>
<li class="toctree-l1"><a class="reference internal" href="azure.html">torchelastic on Azure</a></li>
<li class="toctree-l1"><a class="reference internal" href="kubernetes.html">torchelastic on Kubernetes</a></li>
</ul>
<p class="caption"><span class="caption-text">torchelastic core API</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="checkpoint.html">Checkpoint</a></li>
<li class="toctree-l1"><a class="reference internal" href="metrics.html">Metrics</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <div class="pytorch-container">
      <div class="pytorch-page-level-bar" id="pytorch-page-level-bar">
        <div class="pytorch-breadcrumbs-wrapper">
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="pytorch-breadcrumbs">
    
      <li>
        <a href="index.html">
          
            Docs
          
        </a> &gt;
      </li>

        
      <li>torchelastic on AWS</li>
    
    
      <li class="pytorch-breadcrumbs-aside">
        
            
            <a href="_sources/aws.rst.txt" rel="nofollow"><img src="_static/images/view-page-source-icon.svg"></a>
          
        
      </li>
    
  </ul>

  
</div>
        </div>

        <div class="pytorch-shortcuts-wrapper" id="pytorch-shortcuts-wrapper">
          Shortcuts
        </div>
      </div>

      <section data-toggle="wy-nav-shift" id="pytorch-content-wrap" class="pytorch-content-wrap">
        <div class="pytorch-content-left">

        
          
          <div class="rst-content">
          
            <div role="main" class="main-content" itemscope="itemscope" itemtype="http://schema.org/Article">
             <article itemprop="articleBody" id="pytorch-article" class="pytorch-article">
              
  <div class="section" id="torchelastic-on-aws">
<h1>torchelastic on AWS<a class="headerlink" href="#torchelastic-on-aws" title="Permalink to this headline">¶</a></h1>
<p>This directory contains scripts and libraries that help users run
torchelastic jobs on AWS.</p>
<div class="section" id="prerequisites">
<h2>Prerequisites<a class="headerlink" href="#prerequisites" title="Permalink to this headline">¶</a></h2>
<ol class="arabic simple">
<li><p>Familiarity with basic AWS (EC2, Auto Scaling Groups, S3, EFS).</p></li>
<li><p>(suggested) install and setup
<code class="docutils literal notranslate"><span class="pre">`awscli</span></code> &lt;<a class="reference external" href="https://docs.aws.amazon.com/cli/latest/userguide/cli-chap-install.html">https://docs.aws.amazon.com/cli/latest/userguide/cli-chap-install.html</a>&gt;`__.</p></li>
<li><p>Basic knowledge of containers (we use Docker in our examples).</p></li>
</ol>
</div>
<div class="section" id="requirements">
<h2>Requirements<a class="headerlink" href="#requirements" title="Permalink to this headline">¶</a></h2>
<ol class="arabic simple">
<li><p><code class="docutils literal notranslate"><span class="pre">git</span> <span class="pre">clone</span> <span class="pre">https://github.com/pytorch/elastic.git</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">cd</span> <span class="pre">elastic/aws</span> <span class="pre">&amp;&amp;</span> <span class="pre">pip</span> <span class="pre">install</span> <span class="pre">-r</span> <span class="pre">requirements.txt</span></code></p></li>
<li><p>The following AWS resources:</p>
<ol class="arabic simple">
<li><p>EC2 <a class="reference external" href="https://docs.aws.amazon.com/IAM/latest/UserGuide/id_roles_use_switch-role-ec2_instance-profiles.html">instance
profile</a></p></li>
<li><p><a class="reference external" href="https://docs.aws.amazon.com/vpc/latest/userguide/default-vpc.html#create-default-subnet">Subnet(s)</a></p></li>
<li><p><a class="reference external" href="https://docs.aws.amazon.com/vpc/latest/userguide/VPC_SecurityGroups.html#DefaultSecurityGroup">Security
group</a></p></li>
<li><p>EFS volume</p></li>
<li><p>S3 Bucket</p></li>
</ol>
</li>
<li><p><a class="reference external" href="https://docs.aws.amazon.com/systems-manager/latest/userguide/session-manager-working-with-install-plugin.html">Install</a>
the AWS Session Manager plugin</p></li>
</ol>
</div>
<div class="section" id="quickstart">
<h2>Quickstart<a class="headerlink" href="#quickstart" title="Permalink to this headline">¶</a></h2>
<p>This guide shows how to get a simple torchelastic job running on AWS.
<code class="docutils literal notranslate"><span class="pre">petctl</span></code> is a commandline tool that helps run distributed jobs written
with torchelastic on EC2 instances.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">python3</span> <span class="n">petctl</span><span class="o">.</span><span class="n">py</span> <span class="n">setup</span>
</pre></div>
</div>
<p>This will bootstrap all the AWS resources required to run a torchelastic
job. For details take a look at the CloudFormation
<a class="reference external" href="cfn/setup.yml">template</a> .</p>
<p>Use <code class="docutils literal notranslate"><span class="pre">--s3_bucket</span></code> and <code class="docutils literal notranslate"><span class="pre">--efs_id</span></code> to use an existing S3 bucket and
EFS file system. Otherwise an S3 bucket and EFS volume will be created.</p>
<blockquote>
<div><p><strong>IMPORTANT</strong> when specifying <code class="docutils literal notranslate"><span class="pre">--efs_id</span></code> you MUST ensure that NO
mount targets exist on the EFS file system. torchelastic’s cfn stack
will attempt to create mount targets for the subnets it creates and
WILL FAIL if the file system already has mount targets on a different
VPC. For more information refer to the <a class="reference external" href="https://docs.aws.amazon.com/efs/latest/ug/accessing-fs.html">EFS
docs</a>.</p>
</div></blockquote>
<p><strong>TIP:</strong> If the stack creation fails, log into the CloudFormation
console, inspect the failure reason, address the failure, then manually
delete the stack and re-run <code class="docutils literal notranslate"><span class="pre">petctl</span> <span class="pre">configure</span></code>.</p>
<p>If you are familiar with AWS or already have the resources specified in
the <strong>Requirements</strong> section above, then you can follow the <strong>Manual
Setup</strong> instructions below and simply copy the <a class="reference external" href="config/sample_specs.json">sample specs
file</a> and fill in the template, then run
<code class="docutils literal notranslate"><span class="pre">python</span> <span class="pre">petctl.py</span> <span class="pre">configure</span></code>.</p>
<div class="section" id="write-a-script">
<h3>Write a script<a class="headerlink" href="#write-a-script" title="Permalink to this headline">¶</a></h3>
<p>If you already have a script that uses torchelastic to run distributed
training, great! Otherwise you can use the provided <a class="reference external" href="../examples/imagenet/main.py">imagenet
example</a> or <a class="reference external" href="../examples/classy_vision/main.py">classy
vision</a>. Or… this is a great time
to work on one.</p>
<blockquote>
<div><p>If you are using <code class="docutils literal notranslate"><span class="pre">examples/imagenet/main.py</span></code> you must download the
imagenet dataset from <a class="reference external" href="http://image-net.org/download">here</a> onto
the EFS volume you specified. The dataset will be available to the
workers on <code class="docutils literal notranslate"><span class="pre">/mnt/efs/fs1/&lt;download_dir&gt;</span></code>.</p>
</div></blockquote>
</div>
<div class="section" id="run-the-script">
<h3>Run the script<a class="headerlink" href="#run-the-script" title="Permalink to this headline">¶</a></h3>
<p>We will assume that you are working with the imagenet example and that
you have downloaded the imagenet dataset to
<code class="docutils literal notranslate"><span class="pre">/mnt/efs/fs1/data/imagenet/train</span></code>. To run the script we’ll use
<code class="docutils literal notranslate"><span class="pre">petctl</span></code>,</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>python3 aws/petctl.py run_job --size <span class="m">2</span> --min_size <span class="m">1</span> --max_size <span class="m">3</span> --name <span class="si">${</span><span class="nv">USER</span><span class="si">}</span>-job examples/imagenet/main.py -- --input_path /mnt/efs/fs1/data/imagenet/train
</pre></div>
</div>
<p>In the example above, the named arguments, such as, <code class="docutils literal notranslate"><span class="pre">--size</span></code> ,
<code class="docutils literal notranslate"><span class="pre">--min_size</span></code>, and <code class="docutils literal notranslate"><span class="pre">--max_size</span></code> are parameters to the <code class="docutils literal notranslate"><span class="pre">run_job</span></code>
sub-command of <code class="docutils literal notranslate"><span class="pre">petctl</span></code>. In the example above, we created an
<strong>elastic</strong> job where the initial worker <code class="docutils literal notranslate"><span class="pre">--size=2</span></code>, we are allowed to
scale down to <code class="docutils literal notranslate"><span class="pre">--min_size=1</span></code> and up to <code class="docutils literal notranslate"><span class="pre">--max_size=3</span></code>. This is used
by torchelastic’s rendezvous algorithm to determine how many nodes to
admit on each re-rendezvous before considering the group <em>final</em> and
start the <code class="docutils literal notranslate"><span class="pre">train_step</span></code>.</p>
<p>The other positional arguments have the form:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">[</span><span class="n">local</span> <span class="n">script</span><span class="p">]</span> <span class="o">--</span> <span class="p">[</span><span class="n">script</span> <span class="n">args</span> <span class="o">...</span><span class="p">]</span>
  <span class="o">--</span> <span class="ow">or</span> <span class="o">--</span>
<span class="p">[</span><span class="n">local</span> <span class="n">directory</span><span class="p">]</span> <span class="o">--</span> <span class="p">[</span><span class="n">script</span><span class="p">]</span> <span class="p">[</span><span class="n">script</span> <span class="n">args</span><span class="o">...</span><span class="p">]</span>
</pre></div>
</div>
<p>If the first positional argument is a path to a script file, then the
script is uploaded to S3 and the script arguments specified after the
<code class="docutils literal notranslate"><span class="pre">--</span></code> delimiter are passed through to the script.</p>
<p>If the first positional argument is a directory, then a tarball of the
directory is created and uploaded to S3 and is extracted on the
worker-side. In this case the first argument after the <code class="docutils literal notranslate"><span class="pre">--</span></code> delimiter
is the path to the script <strong>relative</strong> to the specified directory and
the rest of the arguments after the delimiter is passed to the script.</p>
<p>In our example we specified</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">petctl</span><span class="o">.</span><span class="n">py</span> <span class="n">run_job</span> <span class="p">[</span><span class="o">...</span><span class="p">]</span> <span class="n">examples</span><span class="o">/</span><span class="n">imagenet</span><span class="o">/</span><span class="n">main</span><span class="o">.</span><span class="n">py</span> <span class="o">--</span> <span class="o">--</span><span class="n">input_path</span> <span class="o">/</span><span class="n">mnt</span><span class="o">/</span><span class="n">efs</span><span class="o">/</span><span class="n">fs1</span><span class="o">/</span><span class="n">data</span><span class="o">/</span><span class="n">imagenet</span><span class="o">/</span><span class="n">train</span>
</pre></div>
</div>
<p>We could have decided to specify the directory instead</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">petctl</span><span class="o">.</span><span class="n">py</span> <span class="n">run_job</span> <span class="p">[</span><span class="o">...</span><span class="p">]</span> <span class="n">examples</span> <span class="o">--</span> <span class="n">imagenet</span><span class="o">/</span><span class="n">main</span><span class="o">.</span><span class="n">py</span> <span class="o">--</span><span class="n">input_path</span> <span class="o">/</span><span class="n">mnt</span><span class="o">/</span><span class="n">efs</span><span class="o">/</span><span class="n">fs1</span><span class="o">/</span><span class="n">data</span><span class="o">/</span><span class="n">imagenet</span><span class="o">/</span><span class="n">train</span>
</pre></div>
</div>
<p><strong>TIP 1:</strong> Besides a local script or directory you can run with scripts
or <code class="docutils literal notranslate"><span class="pre">tar</span></code> files that have already been uploaded to S3 or directly point
it to a file or directory on the container.</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>python3 petctl.py run_job <span class="o">[</span>...<span class="o">]</span> s3://my-bucket/my_script.py
python3 petctl.py run_job <span class="o">[</span>...<span class="o">]</span> s3://my-bucket/my_dir.tar.gz -- my_script.py

<span class="c1"># or</span>
python3 petctl.py run_job <span class="o">[</span>...<span class="o">]</span> docker:///abs/path/in/container/dir -- my_script.py
python3 petctl.py run_job <span class="o">[</span>...<span class="o">]</span> docker://rel/path/in/container/dir/my_script.py
</pre></div>
</div>
<p><strong>TIP 2:</strong> To iterate quickly, simply make changes to your local script
and upload the script to S3 using</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>python3 petctl.py upload examples/imagenet/main.py s3://&lt;bucket&gt;/&lt;prefix&gt;/&lt;job_name&gt;
</pre></div>
</div>
<p><strong>TIP 3:</strong> Use the EFS volume attached on <code class="docutils literal notranslate"><span class="pre">/mnt/efs/fs1</span></code> on all the
workers to save input data, checkpoints and job output.</p>
<p>Once the <code class="docutils literal notranslate"><span class="pre">run_job</span></code> command returns log into the EC2 console, you will
see two Auto Scaling Groups 1. etcd server 2. workers</p>
<div class="section" id="inspect-the-logs">
<h4>Inspect the logs<a class="headerlink" href="#inspect-the-logs" title="Permalink to this headline">¶</a></h4>
<p>Log into the AWS CloudWatch Logs console. You should see a log group
called <code class="docutils literal notranslate"><span class="pre">torchelastic/$USER</span></code>. Under it there will be a log stream per
instance with the name <code class="docutils literal notranslate"><span class="pre">$job_name/$instance_id</span></code> (e.g.
<code class="docutils literal notranslate"><span class="pre">my_job/i0b938EXAMPLE</span></code>).</p>
</div>
<div class="section" id="troubleshooting">
<h4>Troubleshooting<a class="headerlink" href="#troubleshooting" title="Permalink to this headline">¶</a></h4>
<div class="section" id="ssh">
<h5>SSH<a class="headerlink" href="#ssh" title="Permalink to this headline">¶</a></h5>
<p>To SSH onto the worker nodes to debug/inspect the worker process use AWS
Session Manager instead of the ec2 key pair.
<a class="reference external" href="https://docs.aws.amazon.com/systems-manager/latest/userguide/session-manager-working-with-install-plugin.html">Install</a>
the Session Manager plugin and run</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="c1"># get the instance ids of the workers</span>
python3 petctl.py list_hosts &lt;job_name&gt;

<span class="c1"># ssh onto one of the workers</span>
awscli ssm start-session --target &lt;instance_id&gt;
 -- example --
awscli ssm start-session --target i-00b00EXAMPLE
</pre></div>
</div>
</div>
<div class="section" id="process-status-and-logs">
<h5>Process Status and Logs<a class="headerlink" href="#process-status-and-logs" title="Permalink to this headline">¶</a></h5>
<p>Once SSH’ed, the workers run in a docker container managed by
<code class="docutils literal notranslate"><span class="pre">systemd</span></code>. You can take a look at their console outputs by running</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="c1"># see the status of the worker</span>
sudo systemctl status torchelastic_worker
<span class="c1"># get the container id</span>
sudo docker ps
<span class="c1"># tail the container logs</span>
sudo docker logs -f &lt;container id&gt;
</pre></div>
</div>
<blockquote>
<div><p>Note since we have configured the log driver to be <code class="docutils literal notranslate"><span class="pre">awslogs</span></code>
tailing the docker logs will not work. For more information see:
<a class="reference external" href="https://docs.docker.com/config/containers/logging/awslogs/">https://docs.docker.com/config/containers/logging/awslogs/</a></p>
</div></blockquote>
<p>You can also manually stop and start the workers by running</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>sudo systemctl stop torchelastic_worker
sudo systemctl start torchelastic_worker
</pre></div>
</div>
<blockquote>
<div><p><strong>EXERCISE:</strong> Try stopping or adding worker(s) to see elasticity in
action! To add workers, simply increase the <code class="docutils literal notranslate"><span class="pre">desired</span></code> size of the
worker autoscaling group.</p>
</div></blockquote>
</div>
<div class="section" id="notable-directories">
<h5>Notable Directories<a class="headerlink" href="#notable-directories" title="Permalink to this headline">¶</a></h5>
<ol class="arabic simple">
<li><p>torchelastic_worker systemd:
<code class="docutils literal notranslate"><span class="pre">/etc/systemd/service/torchelastic_worker.service</span></code></p></li>
<li><p>torchelastic run scripts: <code class="docutils literal notranslate"><span class="pre">/var/torchelastic</span></code></p></li>
</ol>
<blockquote>
<div><p><strong>Note</strong>: by design, <code class="docutils literal notranslate"><span class="pre">petctl</span></code> tries to use the least number of AWS
services. This was done intentionally to allow non-AWS users to
easily transfer the functionality to their environment. Hence it
currently does not have the functionality to query status of the job
or to terminate the ASG when the job is done (there is nothing that
is monitoring the job!). In practice consider using EKS, Batch, or
SageMaker.</p>
</div></blockquote>
</div>
</div>
</div>
<div class="section" id="stop-the-script">
<h3>Stop the script<a class="headerlink" href="#stop-the-script" title="Permalink to this headline">¶</a></h3>
<p>To stop the job and tear down the resources, use the <code class="docutils literal notranslate"><span class="pre">kill_job</span></code>
command:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>python3 petctl.py kill_job <span class="si">${</span><span class="nv">USER</span><span class="si">}</span>-job
</pre></div>
</div>
<p>You’ll notice that the two ASGs created with the <code class="docutils literal notranslate"><span class="pre">run_job</span></code> command are
deleted.</p>
</div>
</div>
<div class="section" id="manual-setup">
<h2>Manual Setup<a class="headerlink" href="#manual-setup" title="Permalink to this headline">¶</a></h2>
<div class="section" id="create-specs-file">
<h3>Create specs file<a class="headerlink" href="#create-specs-file" title="Permalink to this headline">¶</a></h3>
<p>First, lets create a launch spec. This is a simple json file that
specifies the launch configuration of EC2 instances. We have included a
<a class="reference external" href="config/sample_specs.json">sample specs file</a> so make a copy and fill
it in. You only need to fill in the fields with
<code class="docutils literal notranslate"><span class="pre">{{</span> <span class="pre">AWS_Resource_Id</span> <span class="pre">}}</span></code>, you can leave the other fields alone for now.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># cd $torchelastic_repository_root</span>
<span class="n">mkdir</span> <span class="o">~/</span><span class="n">torchelastic_workspace</span>
<span class="n">cp</span> <span class="n">aws</span><span class="o">/</span><span class="n">config</span><span class="o">/</span><span class="n">sample_specs</span><span class="o">.</span><span class="n">json</span> <span class="o">~/</span><span class="n">torchelastic_workspace</span><span class="o">/</span><span class="n">specs</span><span class="o">.</span><span class="n">json</span>
</pre></div>
</div>
<p>The specs file is divided into two sections: <code class="docutils literal notranslate"><span class="pre">rdzv</span></code> and <code class="docutils literal notranslate"><span class="pre">worker</span></code>. As
their names imply the <code class="docutils literal notranslate"><span class="pre">rdzv</span></code> section contains the launch specs for the
instances of the rendezvous backend (e.g. etcd). The <code class="docutils literal notranslate"><span class="pre">worker</span></code> section
contains the launch specs for the worker instances.</p>
<p>The following subsections describe the fields in the specs file.</p>
<div class="section" id="instance-type-and-accelerator">
<h4>Instance Type and Accelerator<a class="headerlink" href="#instance-type-and-accelerator" title="Permalink to this headline">¶</a></h4>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="s2">&quot;instance_type&quot;</span> <span class="p">:</span> <span class="s2">&quot;[ec2 instance type]&quot;</span><span class="p">,</span>
<span class="s2">&quot;accelerator&quot;</span> <span class="p">:</span> <span class="s2">&quot;[none | gpu]&quot;</span><span class="p">,</span>
</pre></div>
</div>
<p>The instance type specifies the EC2 instance type to use. The
<code class="docutils literal notranslate"><span class="pre">accelerator</span></code> field can either be <code class="docutils literal notranslate"><span class="pre">none</span></code> or <code class="docutils literal notranslate"><span class="pre">gpu</span></code>. If an EC2
instance that has GPU capability is specified (e.g. <code class="docutils literal notranslate"><span class="pre">g3</span></code>, <code class="docutils literal notranslate"><span class="pre">p2</span></code>,
<code class="docutils literal notranslate"><span class="pre">p3</span></code> instance families) then you must specify <code class="docutils literal notranslate"><span class="pre">accelerator</span> <span class="pre">=</span> <span class="pre">gpu</span></code>.</p>
<blockquote>
<div><p>If <code class="docutils literal notranslate"><span class="pre">accelerator=gpu</span></code> is not specified on a GPU capable instance
type, <code class="docutils literal notranslate"><span class="pre">petctl</span></code> assumes you will only use CPU and will use an AMI
that does not have CUDA nor NVIDIA drivers.</p>
</div></blockquote>
</div>
<div class="section" id="subnet">
<h4>Subnet<a class="headerlink" href="#subnet" title="Permalink to this headline">¶</a></h4>
<p>Note that you can add multiple subnets. Each subnet belongs to an
availability zone (AZ) so you can spread your instances across AZs by
specifying multiple subnets:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="s2">&quot;subnets&quot;</span> <span class="p">:</span> <span class="p">[</span>
  <span class="s2">&quot;[subnet_in_us-west-2a]&quot;</span><span class="p">,</span>
  <span class="s2">&quot;[subnet_in_us-west-2b]&quot;</span><span class="p">,</span>
  <span class="o">...</span>
<span class="p">],</span>
</pre></div>
</div>
<blockquote>
<div><p>Some instances are not available in all AZs, make sure to create the
subnet in the AZ that supports the instance type that you plan to run
your jobs on.</p>
</div></blockquote>
</div>
<div class="section" id="security-group">
<h4>Security Group<a class="headerlink" href="#security-group" title="Permalink to this headline">¶</a></h4>
<p>torchelastic jobs are distributed and hence require nodes to communicate
with each other. Make sure that your security group allows all inbound
traffic between instances within the same security group. &gt; Optionally
you may want to allow inbound SSH access in case you need to log into
the instance for debugging.</p>
</div>
<div class="section" id="ec2-instance-profile">
<h4>EC2 Instance Profile<a class="headerlink" href="#ec2-instance-profile" title="Permalink to this headline">¶</a></h4>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="s2">&quot;instance_role&quot;</span> <span class="p">:</span> <span class="s2">&quot;[ec2 instance profile]&quot;</span><span class="p">,</span>
</pre></div>
</div>
<p>This is the IAM role that is used when accessing other AWS services from
<strong>within</strong> the EC2 instance (e.g. accessing S3 from the worker host). To
learn more about instance profiles refer to the AWS
<a class="reference external" href="https://docs.aws.amazon.com/IAM/latest/UserGuide/id_roles_use_switch-role-ec2_instance-profiles.html">documentation</a>.</p>
<p>Refer to the <code class="docutils literal notranslate"><span class="pre">Ref:</span> <span class="pre">IAMRoleRendezvous</span></code> and <code class="docutils literal notranslate"><span class="pre">Ref:</span> <span class="pre">IAMRoleWorker</span></code>
resources in the CloudFormation <a class="reference external" href="cfn/setup.py">template</a> for a full
list of IAM policies that must be attached to this role.</p>
<blockquote>
<div><p>You may wish to add other privileges to this role depending on what
your workers do. For instance, if your job writes output to S3, then
you will have to attach S3 Write IAM policy to this profile.</p>
</div></blockquote>
</div>
<div class="section" id="s3-bucket-and-prefix">
<h4>S3 Bucket and Prefix<a class="headerlink" href="#s3-bucket-and-prefix" title="Permalink to this headline">¶</a></h4>
<p><code class="docutils literal notranslate"><span class="pre">petctl</span></code> uploads your local script to S3 and pulls it down on the
worker. Specify the S3 bucket and prefix for this purpose:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="s2">&quot;s3_bucket&quot;</span> <span class="p">:</span> <span class="s2">&quot;&lt;YOUR S3 BUCKET NAME&gt;&quot;</span><span class="p">,</span>
<span class="s2">&quot;s3_prefix&quot;</span> <span class="p">:</span> <span class="s2">&quot;&lt;YOUR S3 PREFIX&gt;&quot;</span>
</pre></div>
</div>
</div>
<div class="section" id="additional-worker-specs">
<h4>Additional Worker Specs<a class="headerlink" href="#additional-worker-specs" title="Permalink to this headline">¶</a></h4>
<p>Workers have a couple of additional specs compared to rdzv.</p>
<div class="section" id="docker-image">
<h5>Docker Image<a class="headerlink" href="#docker-image" title="Permalink to this headline">¶</a></h5>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="s2">&quot;docker_image&quot;</span> <span class="p">:</span> <span class="s2">&quot;torchelastic/examples:0.1.0rc1&quot;</span><span class="p">,</span>
</pre></div>
</div>
<p>Note that the <code class="docutils literal notranslate"><span class="pre">worker</span></code> section in the specs file has an extra
<code class="docutils literal notranslate"><span class="pre">docker_image</span></code> configuration. This is because the workers run in a
docker container whereas the rendezvous backend (etcd) runs directly on
the instance. The <code class="docutils literal notranslate"><span class="pre">torchelastic/aws</span></code> image contains torchelastic
(along with all of its dependencies) and a few runtime utilities such as
the <code class="docutils literal notranslate"><span class="pre">fetch_and_run</span></code> script that allows us to run arbitrary user
scripts. For production, you may consider creating your own docker image
with a custom <code class="docutils literal notranslate"><span class="pre">ENTRYPOINT</span></code> specific to your application.</p>
</div>
<div class="section" id="efs">
<h5>EFS<a class="headerlink" href="#efs" title="Permalink to this headline">¶</a></h5>
<p>An Elastic File System volume is mounted on each worker instance (it is
mounted <strong>through</strong> all the way to the container). EFS acts much like
NFS in terms of semantics. Use it as if you were using NFS. You may
store your input dataset, store model checkpoints, or job outputs here.</p>
<blockquote>
<div><p>The specified EFS volume is mounted on <code class="docutils literal notranslate"><span class="pre">/mnt/efs/fs1</span></code>. On the host
and container.</p>
</div></blockquote>
</div>
</div>
</div>
<div class="section" id="configure-petctl">
<h3>Configure <code class="docutils literal notranslate"><span class="pre">petctl</span></code><a class="headerlink" href="#configure-petctl" title="Permalink to this headline">¶</a></h3>
<p>After creating a specs file, configure <code class="docutils literal notranslate"><span class="pre">petctl</span></code></p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">python3</span> <span class="n">petctl</span><span class="o">.</span><span class="n">py</span> <span class="n">configure</span>
</pre></div>
</div>
<p>This will prompt for the <strong>absolute</strong> path of your specs file and the
AWS region. You can run the <code class="docutils literal notranslate"><span class="pre">configure</span></code> sub-command as many times as
you wish in case you made a mistake or you need to reconfigure
<code class="docutils literal notranslate"><span class="pre">petctl</span></code>.</p>
<p>You’ll notice that after configuration is done, there is a config file
generated under <code class="docutils literal notranslate"><span class="pre">$HOME/.petctl</span></code>.</p>
<blockquote>
<div><p>This is similar to how the aws cli is configured. If you decide to
skip configuration, then you <strong>must</strong> pass <code class="docutils literal notranslate"><span class="pre">--specs_file</span></code> and
<code class="docutils literal notranslate"><span class="pre">--region</span></code> arguments to <code class="docutils literal notranslate"><span class="pre">petctl</span></code> each time (e.g.
<code class="docutils literal notranslate"><span class="pre">petctl</span> <span class="pre">--sepcs_file</span> <span class="pre">/home/$USER/specs.json</span> <span class="pre">--region</span> <span class="pre">us-west-2</span></code>).</p>
</div></blockquote>
</div>
</div>
</div>


             </article>
             
            </div>
            <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="azure.html" class="btn btn-neutral float-right" title="torchelastic on Azure" accesskey="n" rel="next">Next <img src="_static/images/chevron-right-orange.svg" class="next-page"></a>
      
      
        <a href="overview.html" class="btn btn-neutral" title="PyTorch Elastic" accesskey="p" rel="prev"><img src="_static/images/chevron-right-orange.svg" class="previous-page"> Previous</a>
      
    </div>
  

  

    <hr>

  

  <div role="contentinfo">
    <p>
        &copy; Copyright 2020, PyTorch Elastic Contributors.

    </p>
  </div>
    
      <div>
        Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>.
      </div>
     

</footer>

          </div>
        </div>

        <div class="pytorch-content-right" id="pytorch-content-right">
          <div class="pytorch-right-menu" id="pytorch-right-menu">
            <div class="pytorch-side-scroll" id="pytorch-side-scroll-right">
              <ul>
<li><a class="reference internal" href="#">torchelastic on AWS</a><ul>
<li><a class="reference internal" href="#prerequisites">Prerequisites</a></li>
<li><a class="reference internal" href="#requirements">Requirements</a></li>
<li><a class="reference internal" href="#quickstart">Quickstart</a><ul>
<li><a class="reference internal" href="#write-a-script">Write a script</a></li>
<li><a class="reference internal" href="#run-the-script">Run the script</a><ul>
<li><a class="reference internal" href="#inspect-the-logs">Inspect the logs</a></li>
<li><a class="reference internal" href="#troubleshooting">Troubleshooting</a><ul>
<li><a class="reference internal" href="#ssh">SSH</a></li>
<li><a class="reference internal" href="#process-status-and-logs">Process Status and Logs</a></li>
<li><a class="reference internal" href="#notable-directories">Notable Directories</a></li>
</ul>
</li>
</ul>
</li>
<li><a class="reference internal" href="#stop-the-script">Stop the script</a></li>
</ul>
</li>
<li><a class="reference internal" href="#manual-setup">Manual Setup</a><ul>
<li><a class="reference internal" href="#create-specs-file">Create specs file</a><ul>
<li><a class="reference internal" href="#instance-type-and-accelerator">Instance Type and Accelerator</a></li>
<li><a class="reference internal" href="#subnet">Subnet</a></li>
<li><a class="reference internal" href="#security-group">Security Group</a></li>
<li><a class="reference internal" href="#ec2-instance-profile">EC2 Instance Profile</a></li>
<li><a class="reference internal" href="#s3-bucket-and-prefix">S3 Bucket and Prefix</a></li>
<li><a class="reference internal" href="#additional-worker-specs">Additional Worker Specs</a><ul>
<li><a class="reference internal" href="#docker-image">Docker Image</a></li>
<li><a class="reference internal" href="#efs">EFS</a></li>
</ul>
</li>
</ul>
</li>
<li><a class="reference internal" href="#configure-petctl">Configure <code class="docutils literal notranslate"><span class="pre">petctl</span></code></a></li>
</ul>
</li>
</ul>
</li>
</ul>

            </div>
          </div>
        </div>
      </section>
    </div>

  


  

     
       <script type="text/javascript" id="documentation_options" data-url_root="./" src="_static/documentation_options.js"></script>
         <script type="text/javascript" src="_static/jquery.js"></script>
         <script type="text/javascript" src="_static/underscore.js"></script>
         <script type="text/javascript" src="_static/doctools.js"></script>
         <script type="text/javascript" src="_static/language_data.js"></script>
         <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/katex@0.11.1/dist/katex.min.js"></script>
         <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/katex@0.11.1/dist/contrib/auto-render.min.js"></script>
         <script type="text/javascript" src="_static/katex_autorenderer.js"></script>
     

  

  <script type="text/javascript" src="_static/js/vendor/popper.min.js"></script>
  <script type="text/javascript" src="_static/js/vendor/bootstrap.min.js"></script>
  <script type="text/javascript" src="_static/js/theme.js"></script>

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

  <!-- Begin Footer -->

  <div class="container-fluid docs-tutorials-resources" id="docs-tutorials-resources">
    <div class="container">
      <div class="row">
        <div class="col-md-4 text-center">
          <h2>Docs</h2>
          <p>Access comprehensive developer documentation for PyTorch</p>
          <a class="with-right-arrow" href="https://pytorch.org/docs/stable/index.html">View Docs</a>
        </div>

        <div class="col-md-4 text-center">
          <h2>Tutorials</h2>
          <p>Get in-depth tutorials for beginners and advanced developers</p>
          <a class="with-right-arrow" href="https://pytorch.org/tutorials">View Tutorials</a>
        </div>

        <div class="col-md-4 text-center">
          <h2>Resources</h2>
          <p>Find development resources and get your questions answered</p>
          <a class="with-right-arrow" href="https://pytorch.org/resources">View Resources</a>
        </div>
      </div>
    </div>
  </div>

  <footer class="site-footer">
    <div class="container footer-container">
      <div class="footer-logo-wrapper">
        <a href="https://pytorch.org/" class="footer-logo"></a>
      </div>

      <div class="footer-links-wrapper">
        <div class="footer-links-col">
          <ul>
            <li class="list-title"><a href="https://pytorch.org/">PyTorch</a></li>
            <li><a href="https://pytorch.org/get-started">Get Started</a></li>
            <li><a href="https://pytorch.org/features">Features</a></li>
            <li><a href="https://pytorch.org/ecosystem">Ecosystem</a></li>
            <li><a href="https://pytorch.org/blog/">Blog</a></li>
            <li><a href="https://pytorch.org/resources">Resources</a></li>
          </ul>
        </div>

        <div class="footer-links-col">
          <ul>
            <li class="list-title"><a href="https://pytorch.org/support">Support</a></li>
            <li><a href="https://pytorch.org/tutorials">Tutorials</a></li>
            <li><a href="https://pytorch.org/docs/stable/index.html">Docs</a></li>
            <li><a href="https://discuss.pytorch.org" target="_blank">Discuss</a></li>
            <li><a href="https://github.com/pytorch/pytorch/issues" target="_blank">Github Issues</a></li>
            <li><a href="https://pytorch.slack.com" target="_blank">Slack</a></li>
            <li><a href="https://github.com/pytorch/pytorch/blob/master/CONTRIBUTING.md" target="_blank">Contributing</a></li>
          </ul>
        </div>

        <div class="footer-links-col follow-us-col">
          <ul>
            <li class="list-title">Follow Us</li>
            <li>
              <div id="mc_embed_signup">
                <form
                  action="https://twitter.us14.list-manage.com/subscribe/post?u=75419c71fe0a935e53dfa4a3f&id=91d0dccd39"
                  method="post"
                  id="mc-embedded-subscribe-form"
                  name="mc-embedded-subscribe-form"
                  class="email-subscribe-form validate"
                  target="_blank"
                  novalidate>
                  <div id="mc_embed_signup_scroll" class="email-subscribe-form-fields-wrapper">
                    <div class="mc-field-group">
                      <label for="mce-EMAIL" style="display:none;">Email Address</label>
                      <input type="email" value="" name="EMAIL" class="required email" id="mce-EMAIL" placeholder="Email Address">
                    </div>

                    <div id="mce-responses" class="clear">
                      <div class="response" id="mce-error-response" style="display:none"></div>
                      <div class="response" id="mce-success-response" style="display:none"></div>
                    </div>    <!-- real people should not fill this in and expect good things - do not remove this or risk form bot signups-->

                    <div style="position: absolute; left: -5000px;" aria-hidden="true"><input type="text" name="b_75419c71fe0a935e53dfa4a3f_91d0dccd39" tabindex="-1" value=""></div>

                    <div class="clear">
                      <input type="submit" value="" name="subscribe" id="mc-embedded-subscribe" class="button email-subscribe-button">
                    </div>
                  </div>
                </form>
              </div>

            </li>
          </ul>

          <div class="footer-social-icons">
            <a href="https://www.facebook.com/pytorch" target="_blank" class="facebook"></a>
            <a href="https://twitter.com/pytorch" target="_blank" class="twitter"></a>
          </div>
        </div>
      </div>
    </div>
  </footer>

  <div class="cookie-banner-wrapper">
  <div class="container">
    <p class="gdpr-notice">To analyze traffic and optimize your experience, we serve cookies on this site. By clicking or navigating, you agree to allow our usage of cookies. As the current maintainers of this site, Facebook’s Cookies Policy applies. Learn more, including about available controls: <a href="https://www.facebook.com/policies/cookies/">Cookies Policy</a>.</p>
    <img class="close-button" src="_static/images/pytorch-x.svg">
  </div>
</div>

  <!-- End Footer -->

  <!-- Begin Mobile Menu -->

  <div class="mobile-main-menu">
    <div class="container-fluid">
      <div class="container">
        <div class="mobile-main-menu-header-container">
          <a class="header-logo" href="https://pytorch.org/" aria-label="PyTorch"></a>
          <a class="main-menu-close-button" href="#" data-behavior="close-mobile-menu"></a>
        </div>
      </div>
    </div>

    <div class="mobile-main-menu-links-container">
      <div class="main-menu">
        <ul>
          <li>
            <a href="https://pytorch.org/get-started">Get Started</a>
          </li>

          <li>
            <a href="https://pytorch.org/features">Features</a>
          </li>

          <li>
            <a href="https://pytorch.org/ecosystem">Ecosystem</a>
          </li>

          <li>
            <a href="https://pytorch.org/mobile">Mobile</a>
          </li>

          <li>
            <a href="https://pytorch.org/hub">PyTorch Hub</a>
          </li>

          <li>
            <a href="https://pytorch.org/blog/">Blog</a>
          </li>

          <li>
            <a href="https://pytorch.org/tutorials">Tutorials</a>
          </li>

          <li>
            <a href="https://pytorch.org/docs/stable/index.html">Docs</a>
          </li>

          <li>
            <a href="https://pytorch.org/resources">Resources</a>
          </li>

          <li>
            <a href="https://github.com/pytorch/pytorch">Github</a>
          </li>
        </ul>
      </div>
    </div>
  </div>

  <!-- End Mobile Menu -->

  <script type="text/javascript" src="_static/js/vendor/anchor.min.js"></script>

  <script type="text/javascript">
    $(document).ready(function() {
      mobileMenu.bind();
      mobileTOC.bind();
      pytorchAnchors.bind();
      sideMenus.bind();
      scrollToAnchor.bind();
      highlightNavigation.bind();
      mainMenuDropdown.bind();

      // Add class to links that have code blocks, since we cannot create links in code blocks
      $("article.pytorch-article a span.pre").each(function(e) {
        $(this).closest("a").addClass("has-code");
      });
    })
  </script>
</body>
</html>