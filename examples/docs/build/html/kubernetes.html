


<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>torchelastic on Kubernetes &mdash; PyTorch/Elastic master documentation</title>
  

  
  
  
  

  

  
  
    

  

  <link rel="stylesheet" href="_static/css/theme.css" type="text/css" />
  <!-- <link rel="stylesheet" href="_static/pygments.css" type="text/css" /> -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.10.0-beta/dist/katex.min.css" type="text/css" />
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.11.1/dist/katex.min.css" type="text/css" />
  <link rel="stylesheet" href="_static/katex-math.css" type="text/css" />
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="Checkpoint" href="checkpoint.html" />
    <link rel="prev" title="torchelastic on Azure" href="azure.html" /> 

  
  <script src="_static/js/modernizr.min.js"></script>

  <!-- Preload the theme fonts -->

<link rel="preload" href="_static/fonts/FreightSans/freight-sans-book.woff2" as="font" type="font/woff2" crossorigin="anonymous">
<link rel="preload" href="_static/fonts/FreightSans/freight-sans-medium.woff2" as="font" type="font/woff2" crossorigin="anonymous">
<link rel="preload" href="_static/fonts/IBMPlexMono/IBMPlexMono-Medium.woff2" as="font" type="font/woff2" crossorigin="anonymous">
<link rel="preload" href="_static/fonts/FreightSans/freight-sans-bold.woff2" as="font" type="font/woff2" crossorigin="anonymous">
<link rel="preload" href="_static/fonts/FreightSans/freight-sans-medium-italic.woff2" as="font" type="font/woff2" crossorigin="anonymous">
<link rel="preload" href="_static/fonts/IBMPlexMono/IBMPlexMono-SemiBold.woff2" as="font" type="font/woff2" crossorigin="anonymous">

<!-- Preload the katex fonts -->

<link rel="preload" href="https://cdn.jsdelivr.net/npm/katex@0.10.0/dist/fonts/KaTeX_Math-Italic.woff2" as="font" type="font/woff2" crossorigin="anonymous">
<link rel="preload" href="https://cdn.jsdelivr.net/npm/katex@0.10.0/dist/fonts/KaTeX_Main-Regular.woff2" as="font" type="font/woff2" crossorigin="anonymous">
<link rel="preload" href="https://cdn.jsdelivr.net/npm/katex@0.10.0/dist/fonts/KaTeX_Main-Bold.woff2" as="font" type="font/woff2" crossorigin="anonymous">
<link rel="preload" href="https://cdn.jsdelivr.net/npm/katex@0.10.0/dist/fonts/KaTeX_Size1-Regular.woff2" as="font" type="font/woff2" crossorigin="anonymous">
<link rel="preload" href="https://cdn.jsdelivr.net/npm/katex@0.10.0/dist/fonts/KaTeX_Size4-Regular.woff2" as="font" type="font/woff2" crossorigin="anonymous">
<link rel="preload" href="https://cdn.jsdelivr.net/npm/katex@0.10.0/dist/fonts/KaTeX_Size2-Regular.woff2" as="font" type="font/woff2" crossorigin="anonymous">
<link rel="preload" href="https://cdn.jsdelivr.net/npm/katex@0.10.0/dist/fonts/KaTeX_Size3-Regular.woff2" as="font" type="font/woff2" crossorigin="anonymous">
<link rel="preload" href="https://cdn.jsdelivr.net/npm/katex@0.10.0/dist/fonts/KaTeX_Caligraphic-Regular.woff2" as="font" type="font/woff2" crossorigin="anonymous">
</head>

<div class="container-fluid header-holder tutorials-header" id="header-holder">
  <div class="container">
    <div class="header-container">
      <a class="header-logo" href="https://pytorch.org/" aria-label="PyTorch"></a>

      <div class="main-menu">
        <ul>
          <li>
            <a href="https://pytorch.org/get-started">Get Started</a>
          </li>

          <li>
            <div class="ecosystem-dropdown">
              <a id="dropdownMenuButton" data-toggle="ecosystem-dropdown">
                Ecosystem
              </a>
              <div class="ecosystem-dropdown-menu">
                <a class="nav-dropdown-item" href="https://pytorch.org/hub"">
                  <span class=dropdown-title>Models (Beta)</span>
                  <p>Discover, publish, and reuse pre-trained models</p>
                </a>
                <a class="nav-dropdown-item" href="https://pytorch.org/ecosystem">
                  <span class=dropdown-title>Tools & Libraries</span>
                  <p>Explore the ecosystem of tools and libraries</p>
                </a>
              </div>
            </div>
          </li>

          <li>
            <a href="https://pytorch.org/mobile">Mobile</a>
          </li>

          <li>
            <a href="https://pytorch.org/blog/">Blog</a>
          </li>

          <li>
            <a href="https://pytorch.org/tutorials">Tutorials</a>
          </li>

          <li>
            <a href="https://pytorch.org/docs/stable/index.html">Docs</a>
          </li>

          <li>
            <div class="resources-dropdown">
              <a id="resourcesDropdownButton" data-toggle="resources-dropdown">
                Resources
              </a>
              <div class="resources-dropdown-menu">
                <a class="nav-dropdown-item" href="https://pytorch.org/resources"">
                  <span class=dropdown-title>Developer Resources</span>
                  <p>Find resources and get questions answered</p>
                </a>
                <a class="nav-dropdown-item" href="https://pytorch.org/features">
                  <span class=dropdown-title>About</span>
                  <p>Learn about PyTorch’s features and capabilities</p>
                </a>
              </div>
            </div>
          </li>

          <li>
            <a href="https://github.com/pytorch/pytorch">Github</a>
          </li>
        </ul>
      </div>

      <a class="main-menu-open-button" href="#" data-behavior="open-mobile-menu"></a>
    </div>

  </div>
</div>


<body class="pytorch-body">

   

    

    <div class="table-of-contents-link-wrapper">
      <span>Table of Contents</span>
      <a href="#" class="toggle-table-of-contents" data-behavior="toggle-table-of-contents"></a>
    </div>

    <nav data-toggle="wy-nav-shift" class="pytorch-left-menu" id="pytorch-left-menu">
      <div class="pytorch-side-scroll">
        <div class="pytorch-menu pytorch-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          <div class="pytorch-left-menu-search">
            

            
              
              
                <div class="version">
                  master 
                </div>
              
            

            


  


<div role="search">
  <form id="rtd-search-form" class="wy-form" action="search.html" method="get">
    <input type="text" name="q" placeholder="Search Docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

            
          </div>

          
            
            
              
            
            
              <p class="caption"><span class="caption-text">Documentation</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="overview.html">PyTorch Elastic</a></li>
</ul>
<p class="caption"><span class="caption-text">Runtime</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="aws.html">torchelastic on AWS</a></li>
<li class="toctree-l1"><a class="reference internal" href="azure.html">torchelastic on Azure</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">torchelastic on Kubernetes</a></li>
</ul>
<p class="caption"><span class="caption-text">torchelastic core API</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="checkpoint.html">Checkpoint</a></li>
<li class="toctree-l1"><a class="reference internal" href="metrics.html">Metrics</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <div class="pytorch-container">
      <div class="pytorch-page-level-bar" id="pytorch-page-level-bar">
        <div class="pytorch-breadcrumbs-wrapper">
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="pytorch-breadcrumbs">
    
      <li>
        <a href="index.html">
          
            Docs
          
        </a> &gt;
      </li>

        
      <li>torchelastic on Kubernetes</li>
    
    
      <li class="pytorch-breadcrumbs-aside">
        
            
            <a href="_sources/kubernetes.rst.txt" rel="nofollow"><img src="_static/images/view-page-source-icon.svg"></a>
          
        
      </li>
    
  </ul>

  
</div>
        </div>

        <div class="pytorch-shortcuts-wrapper" id="pytorch-shortcuts-wrapper">
          Shortcuts
        </div>
      </div>

      <section data-toggle="wy-nav-shift" id="pytorch-content-wrap" class="pytorch-content-wrap">
        <div class="pytorch-content-left">

        
          
          <div class="rst-content">
          
            <div role="main" class="main-content" itemscope="itemscope" itemtype="http://schema.org/Article">
             <article itemprop="articleBody" id="pytorch-article" class="pytorch-article">
              
  <div class="section" id="torchelastic-on-kubernetes">
<h1>torchelastic on Kubernetes<a class="headerlink" href="#torchelastic-on-kubernetes" title="Permalink to this headline">¶</a></h1>
<p>This directory contains kubernetes resources that help users run
torchelastic jobs on Kubernetes. We use <a class="reference external" href="https://aws.amazon.com/eks/">Amazon
EKS</a> as an example here, the steps would
also work for all other cloud providers (You need to find alternative
storage options in your environment)</p>
<div class="section" id="prerequisites">
<h2>Prerequisites<a class="headerlink" href="#prerequisites" title="Permalink to this headline">¶</a></h2>
<ol class="arabic simple">
<li><p>Setup AWS credentials on your machine.</p></li>
<li><p><a class="reference external" href="https://eksctl.io/">eksctl</a> to manage Kubernetes cluster.</p></li>
<li><p>Network file storage which supports ReadWriteMany mode.
<a class="reference external" href="https://aws.amazon.com/efs/">EFS</a>, <a class="reference external" href="https://aws.amazon.com/fsx/lustre/">FSx for
Lustrue</a> are good examples.</p></li>
<li><p><a class="reference external" href="https://aws.amazon.com/s3/">S3</a> bucket to host training scripts.</p></li>
</ol>
</div>
<div class="section" id="quickstart">
<h2>Quickstart<a class="headerlink" href="#quickstart" title="Permalink to this headline">¶</a></h2>
<p>This guide shows how to get a torchelastic job running on EKS.</p>
<div class="section" id="create-kubernetes-cluster">
<h3>Create Kubernetes cluster<a class="headerlink" href="#create-kubernetes-cluster" title="Permalink to this headline">¶</a></h3>
<p>We highly recommend to use <a class="reference external" href="https://eksctl.io/">eksctl</a> to create
Amazon EKS cluster. This process will take 10~15 minutes.</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$ eksctl create cluster <span class="se">\</span>
    --name<span class="o">=</span>torchelastic <span class="se">\</span>
    --node-type<span class="o">=</span>p3.2xlarge <span class="se">\</span>
    --region<span class="o">=</span>us-west-2 <span class="se">\</span>
    --version<span class="o">=</span><span class="m">1</span>.14 <span class="se">\</span>
    --ssh-access <span class="se">\</span>
    --ssh-public-key<span class="o">=</span>~/.ssh/id_rsa.pub <span class="se">\</span>
    --nodes<span class="o">=</span><span class="m">2</span>
</pre></div>
</div>
</div>
<div class="section" id="install-nvidia-device-plugin">
<h3>Install Nvidia Device Plugin<a class="headerlink" href="#install-nvidia-device-plugin" title="Permalink to this headline">¶</a></h3>
<p>In order to enable GPU support in your EKS cluster, deploy the following
Daemonset:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$ kubectl create -f https://raw.githubusercontent.com/NVIDIA/k8s-device-plugin/1.0.0-beta4/nvidia-device-plugin.yml
</pre></div>
</div>
</div>
<div class="section" id="prepare-storage">
<h3>Prepare storage<a class="headerlink" href="#prepare-storage" title="Permalink to this headline">¶</a></h3>
<div class="section" id="create-efs-and-mount-targets">
<h4>Create EFS and mount targets<a class="headerlink" href="#create-efs-and-mount-targets" title="Permalink to this headline">¶</a></h4>
<p>Create an EFS volume in AWS console. <code class="docutils literal notranslate"><span class="pre">eksctl</span></code> will create a new VPC
for the cluster, please select the VPC to make sure EKS cluster nodes
can access EFS. Select <code class="docutils literal notranslate"><span class="pre">Public</span></code> subnets when you create mount targets.
Please use security group <code class="docutils literal notranslate"><span class="pre">*ClusterSharedNodeSecurityGroup*</span></code> created
by <code class="docutils literal notranslate"><span class="pre">eksctl</span></code> to associate with the mount targets.</p>
<div class="figure align-default" id="id1">
<img alt="efs-setup-diagram" src="../docs/_static/img/efs-setup.jpg" />
<p class="caption"><span class="caption-text">efs-setup-diagram</span><a class="headerlink" href="#id1" title="Permalink to this image">¶</a></p>
</div>
</div>
<div class="section" id="install-efs-csi-driver">
<h4>Install EFS CSI Driver<a class="headerlink" href="#install-efs-csi-driver" title="Permalink to this headline">¶</a></h4>
<p>EFS CSI Driver manages the lifecycle of Amazon EFS filesystems in
Kubernetes.</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>kubectl apply -k <span class="s2">&quot;github.com/kubernetes-sigs/aws-efs-csi-driver/deploy/kubernetes/overlays/stable/?ref=master&quot;</span>
</pre></div>
</div>
<blockquote>
<div><p>Note: If you use kubernetes cluster &lt; 1.14, please follow
<a class="reference external" href="https://github.com/kubernetes-sigs/aws-efs-csi-driver">instructions</a>
to install older CSI versions.</p>
</div></blockquote>
</div>
<div class="section" id="create-persistentvolume-and-persistentvolumeclaim">
<h4>Create PersistentVolume and PersistentVolumeClaim<a class="headerlink" href="#create-persistentvolume-and-persistentvolumeclaim" title="Permalink to this headline">¶</a></h4>
<p>Once the file system is statically provisioned and CSI driver is ready.
EFS can be mounted inside a container as a volume using the driver.</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="nb">export</span> <span class="nv">EFS_ID</span><span class="o">=</span>your_efs_id
sed -i <span class="s1">&#39;&#39;</span> <span class="s1">&#39;s/&lt;EFS_ID&gt;/&#39;</span><span class="s2">&quot;</span><span class="nv">$EFS_ID</span><span class="s2">&quot;</span><span class="s1">&#39;/&#39;</span> storage.yaml

kubectl apply -f storage.yaml
</pre></div>
</div>
</div>
<div class="section" id="download-imagenet-dataset">
<h4>Download imagenet dataset<a class="headerlink" href="#download-imagenet-dataset" title="Permalink to this headline">¶</a></h4>
<p>In this example, we use <a class="reference external" href="https://tiny-imagenet.herokuapp.com/">tiny imagenet
dataset</a> instead of full
dataset because dataset is small and easy to download. It only has 200
classes. Each class has 500 training images, 50 validation images, and
50 test images.</p>
<blockquote>
<div><p>Note: You can download full imagenet dataset
<a class="reference external" href="http://www.image-net.org/">here</a>.</p>
</div></blockquote>
<p>Run following scripts to create a pods to prefetch dataset on NFS.</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>cat &lt;&lt;EOF | kubectl apply -f -
apiVersion: v1
kind: Pod
metadata:
  name: download-dataset-task
spec:
  restartPolicy: OnFailure
  containers:
  - name: app
    image: centos:latest
    command:
    - /bin/sh
    - &quot;-c&quot;
    - |
      /bin/bash &lt;&lt;&#39;EOF&#39;
      yum update
      yum install -y wget unzip
      wget http://cs231n.stanford.edu/tiny-imagenet-200.zip
      unzip tiny-imagenet-200.zip -d /data
      EOF
    volumeMounts:
    - name: persistent-storage
      mountPath: /data
  volumes:
  - name: persistent-storage
    persistentVolumeClaim:
      claimName: efs-claim
EOF
</pre></div>
</div>
<blockquote>
<div><p>Note: Job running time may vary from 10 mins to 30 mins depending on
the throughput and performance mode you configure for your EFS.</p>
</div></blockquote>
</div>
</div>
<div class="section" id="lauch-etcd-instance">
<h3>Lauch etcd instance<a class="headerlink" href="#lauch-etcd-instance" title="Permalink to this headline">¶</a></h3>
<p>This will give you a single etcd instance, your training workers later
can talk to this etcd instance for peer discovery and distributed
synchronization.</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$ kubectl apply -f etcd.yaml
</pre></div>
</div>
</div>
<div class="section" id="launch-torchelastic-job">
<h3>Launch torchelastic job<a class="headerlink" href="#launch-torchelastic-job" title="Permalink to this headline">¶</a></h3>
<div class="section" id="update-training-scripts-location">
<h4>Update training scripts location<a class="headerlink" href="#update-training-scripts-location" title="Permalink to this headline">¶</a></h4>
<p>In this example, we’d like to reuse container image
<code class="docutils literal notranslate"><span class="pre">torchelastic/examples:0.1.0rc1</span></code>, then we need to upload training
scripts <a class="reference external" href="../examples/imagenet/main.py">main.py</a> to a S3 bucket. In
addition, args in <code class="docutils literal notranslate"><span class="pre">imagenet.yaml</span></code> needs to be updated as well. Please
update <code class="docutils literal notranslate"><span class="pre">s3://&lt;BUCKET&gt;/petctl/&lt;USER&gt;/&lt;JOB_ID&gt;/main.py</span></code> to the your file
location.</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>containers:
  - name: elastic-trainer-worker
    image: torchelastic/examples:0.1.0rc1
    args:
    - <span class="s2">&quot;s3://&lt;BUCKET&gt;/petctl/&lt;USER&gt;/&lt;JOB_ID&gt;/main.py&quot;</span>
    - <span class="s2">&quot;--input_path&quot;</span>
    ....
    ....
</pre></div>
</div>
<blockquote>
<div><p>Note: You can export env <code class="docutils literal notranslate"><span class="pre">BUCKET</span></code>, <code class="docutils literal notranslate"><span class="pre">USER</span></code>, <code class="docutils literal notranslate"><span class="pre">JOB_ID</span></code> and replace
values in the file.</p>
</div></blockquote>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">sed</span> <span class="o">-</span><span class="n">i</span> <span class="s1">&#39;&#39;</span> <span class="s1">&#39;s/&lt;BUCKET&gt;/&#39;</span><span class="s2">&quot;$BUCKET&quot;</span><span class="s1">&#39;/; s/&lt;USER&gt;/&#39;</span><span class="s2">&quot;$USER&quot;</span><span class="s1">&#39;/; s/&lt;JOB_ID&gt;/&#39;</span><span class="s2">&quot;$JOB_ID&quot;</span><span class="s1">&#39;/;&#39;</span> <span class="n">imagenet</span><span class="o">.</span><span class="n">yaml</span>
</pre></div>
</div>
<blockquote>
<div><p>Note: If you don’t like to use S3 or use a different cloud provider,
please modify <a class="reference external" href="../examples/Dockerfile">Dockerfile</a> and create your
own container image.</p>
</div></blockquote>
</div>
<div class="section" id="attach-s3-access-to-eks-worker-nodes">
<h4>Attach S3 access to EKS worker nodes<a class="headerlink" href="#attach-s3-access-to-eks-worker-nodes" title="Permalink to this headline">¶</a></h4>
<p>In order to make trainining container to successfully download
<code class="docutils literal notranslate"><span class="pre">main.py</span></code> from S3 to local, you need to grant S3 access to your worker
nodes. Go to AWS IAM console, attach <code class="docutils literal notranslate"><span class="pre">AmazonS3ReadOnlyAccess</span></code> policy
to the role. The worker nodegroup role created by <code class="docutils literal notranslate"><span class="pre">eksctl</span></code> will looks
like <code class="docutils literal notranslate"><span class="pre">eksctl-torchelastic-nodegroup-***-NodeInstanceRole-***</span></code></p>
</div>
<div class="section" id="create-workers">
<h4>Create workers<a class="headerlink" href="#create-workers" title="Permalink to this headline">¶</a></h4>
<p>Kubernetes will create two pods and two headless services. The headless
services is created for pod to pod communication using hostname.</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$ kubectl apply -f imagenet.yaml
pod/imagenet-worker-1 created
service/imagenet-worker-1 created
pod/imagenet-worker-2 created
service/imagenet-worker-2 created
</pre></div>
</div>
</div>
</div>
<div class="section" id="check-worker-logs">
<h3>Check worker logs<a class="headerlink" href="#check-worker-logs" title="Permalink to this headline">¶</a></h3>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$ kubectl logs -f imagenet-worker-1

download: s3://torchelastic-shjiaxin-1h71m-s3bucket-m1b9b9pjldqw/petctl/shjiaxin/imagenet-job/main.py to ../tmp/fetch_and_run_ee5yh8qm/s3_file_x8ure7if
<span class="o">[</span>INFO<span class="o">]</span> <span class="m">2020</span>-01-03 <span class="m">23</span>:08:49,297 main: rdzv init <span class="nv">method</span><span class="o">=</span>etcd://etcd:2379/imagenet?min_workers<span class="o">=</span><span class="m">1</span><span class="p">&amp;</span><span class="nv">max_workers</span><span class="o">=</span><span class="m">3</span><span class="p">&amp;</span><span class="nv">last_call_timeout</span><span class="o">=</span><span class="m">5</span>
<span class="o">[</span>INFO<span class="o">]</span> <span class="m">2020</span>-01-03 <span class="m">23</span>:08:49,298 main: Loading data from: /data/tiny-imagenet-200/train
<span class="o">[</span>INFO<span class="o">]</span> <span class="m">2020</span>-01-03 <span class="m">23</span>:09:16,761 main: Loading model: resnet101
<span class="o">[</span>INFO<span class="o">]</span> <span class="m">2020</span>-01-03 <span class="m">23</span>:09:20,231 main: Rank <span class="o">[</span><span class="m">0</span><span class="o">]</span> running on GPU <span class="o">[</span><span class="m">0</span><span class="o">]</span>
INFO <span class="m">2020</span>-01-03 <span class="m">23</span>:09:20,234 Etcd machines: <span class="o">[</span><span class="s1">&#39;http://0.0.0.0:2379&#39;</span><span class="o">]</span>
<span class="o">[</span>INFO<span class="o">]</span> <span class="m">2020</span>-01-03 <span class="m">23</span>:09:20,241 main: Entering torchelastic train_loop
INFO <span class="m">2020</span>-01-03 <span class="m">23</span>:09:20,242 Attempting to join next rendezvous
INFO <span class="m">2020</span>-01-03 <span class="m">23</span>:09:20,244 Observed existing rendezvous state: <span class="o">{</span><span class="s1">&#39;status&#39;</span>: <span class="s1">&#39;joinable&#39;</span>, <span class="s1">&#39;version&#39;</span>: <span class="s1">&#39;1&#39;</span>, <span class="s1">&#39;participants&#39;</span>: <span class="o">[</span><span class="m">0</span><span class="o">]}</span>
INFO <span class="m">2020</span>-01-03 <span class="m">23</span>:09:20,255 Joined rendezvous version <span class="m">1</span> as rank <span class="m">1</span>. Full state: <span class="o">{</span><span class="s1">&#39;status&#39;</span>: <span class="s1">&#39;joinable&#39;</span>, <span class="s1">&#39;version&#39;</span>: <span class="s1">&#39;1&#39;</span>, <span class="s1">&#39;participants&#39;</span>: <span class="o">[</span><span class="m">0</span>, <span class="m">1</span><span class="o">]}</span>
INFO <span class="m">2020</span>-01-03 <span class="m">23</span>:09:20,255 Waiting <span class="k">for</span> remaining peers.
INFO <span class="m">2020</span>-01-03 <span class="m">23</span>:09:25,265 All peers arrived. Confirming membership.
INFO <span class="m">2020</span>-01-03 <span class="m">23</span>:09:25,363 Waiting <span class="k">for</span> confirmations from all peers.
INFO <span class="m">2020</span>-01-03 <span class="m">23</span>:09:25,367 Rendezvous version <span class="m">1</span> is complete. Final state: <span class="o">{</span><span class="s1">&#39;status&#39;</span>: <span class="s1">&#39;final&#39;</span>, <span class="s1">&#39;version&#39;</span>: <span class="s1">&#39;1&#39;</span>, <span class="s1">&#39;participants&#39;</span>: <span class="o">[</span><span class="m">0</span>, <span class="m">1</span><span class="o">]</span>, <span class="s1">&#39;keep_alives&#39;</span>: <span class="o">[</span><span class="s1">&#39;/torchelastic/p2p/run_imagenet/rdzv/v_1/rank_1&#39;</span>, <span class="s1">&#39;/torchelastic/p2p/run_imagenet/rdzv/v_1/rank_0&#39;</span><span class="o">]</span>, <span class="s1">&#39;num_workers_waiting&#39;</span>: <span class="m">0</span><span class="o">}</span>
INFO <span class="m">2020</span>-01-03 <span class="m">23</span>:09:25,367 Using TCPStore <span class="k">for</span> c10d::Store implementation
INFO <span class="m">2020</span>-01-03 <span class="m">23</span>:09:25,371 Rank <span class="m">1</span> will conenct to TCPStore server at imagenet-worker-2:51903
<span class="o">[</span>INFO<span class="o">]</span> <span class="m">2020</span>-01-03 <span class="m">23</span>:09:25,372 coordinator_p2p: Got next rendezvous: rank <span class="m">1</span>, world size <span class="m">2</span>
<span class="o">[</span>INFO<span class="o">]</span> <span class="m">2020</span>-01-03 <span class="m">23</span>:09:25,383 coordinator_p2p: Initialized process group rank <span class="m">1</span>, world size <span class="m">2</span>
<span class="o">[</span>INFO<span class="o">]</span> <span class="m">2020</span>-01-03 <span class="m">23</span>:09:25,385 main: Rank <span class="m">1</span>: Model state synced from rank: <span class="m">0</span>
    <span class="nv">batch_size</span><span class="o">=</span><span class="m">32</span>
    <span class="nv">num_data_workers</span><span class="o">=</span><span class="m">0</span>
    <span class="nv">data_start_index</span><span class="o">=</span><span class="m">0</span>
    <span class="nv">iteration</span><span class="o">=</span><span class="m">0</span>
    <span class="nv">epoch</span><span class="o">=</span><span class="m">0</span>/10
<span class="o">[</span>INFO<span class="o">]</span> <span class="m">2020</span>-01-03 <span class="m">23</span>:09:25,629 train_loop: Rank <span class="m">1</span> synced state with other nodes
<span class="o">[</span>INFO<span class="o">]</span> <span class="m">2020</span>-01-03 <span class="m">23</span>:09:27,288 main: epoch: <span class="m">0</span>, iteration: <span class="m">0</span>, data_idx: <span class="m">0</span>
<span class="o">[</span>INFO<span class="o">]</span> <span class="m">2020</span>-01-03 <span class="m">23</span>:09:28,856 main: epoch: <span class="m">0</span>, iteration: <span class="m">1</span>, data_idx: <span class="m">96</span>
<span class="o">[</span>INFO<span class="o">]</span> <span class="m">2020</span>-01-03 <span class="m">23</span>:09:30,434 main: epoch: <span class="m">0</span>, iteration: <span class="m">2</span>, data_idx: <span class="m">192</span>
<span class="o">[</span>INFO<span class="o">]</span> <span class="m">2020</span>-01-03 <span class="m">23</span>:09:31,992 main: epoch: <span class="m">0</span>, iteration: <span class="m">3</span>, data_idx: <span class="m">288</span>
<span class="o">[</span>INFO<span class="o">]</span> <span class="m">2020</span>-01-03 <span class="m">23</span>:09:33,543 main: epoch: <span class="m">0</span>, iteration: <span class="m">4</span>, data_idx: <span class="m">384</span>
<span class="o">[</span>INFO<span class="o">]</span> <span class="m">2020</span>-01-03 <span class="m">23</span>:09:35,120 main: epoch: <span class="m">0</span>, iteration: <span class="m">5</span>, data_idx: <span class="m">480</span>
<span class="o">[</span>INFO<span class="o">]</span> <span class="m">2020</span>-01-03 <span class="m">23</span>:09:36,685 main: epoch: <span class="m">0</span>, iteration: <span class="m">6</span>, data_idx: <span class="m">576</span>
<span class="o">[</span>INFO<span class="o">]</span> <span class="m">2020</span>-01-03 <span class="m">23</span>:09:38,256 main: epoch: <span class="m">0</span>, iteration: <span class="m">7</span>, data_idx: <span class="m">672</span>
<span class="o">[</span>INFO<span class="o">]</span> <span class="m">2020</span>-01-03 <span class="m">23</span>:09:39,835 main: epoch: <span class="m">0</span>, iteration: <span class="m">8</span>, data_idx: <span class="m">768</span>
<span class="o">[</span>INFO<span class="o">]</span> <span class="m">2020</span>-01-03 <span class="m">23</span>:09:41,420 main: epoch: <span class="m">0</span>, iteration: <span class="m">9</span>, data_idx: <span class="m">864</span>
<span class="o">[</span>INFO<span class="o">]</span> <span class="m">2020</span>-01-03 <span class="m">23</span>:09:42,981 main: epoch: <span class="m">0</span>, iteration: <span class="m">10</span>, data_idx: <span class="m">960</span>
</pre></div>
</div>
</div>
<div class="section" id="clean-up-job">
<h3>Clean up job<a class="headerlink" href="#clean-up-job" title="Permalink to this headline">¶</a></h3>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ kubectl delete -f imagenet.yaml
</pre></div>
</div>
</div>
</div>
<div class="section" id="elasticity">
<h2>Elasticity<a class="headerlink" href="#elasticity" title="Permalink to this headline">¶</a></h2>
<p>You can launch new pods with same configuration to join the training or
delete individual pod to check</p>
</div>
<div class="section" id="torchelastic-operator">
<h2>torchelastic operator<a class="headerlink" href="#torchelastic-operator" title="Permalink to this headline">¶</a></h2>
<p>Above example is a hard way to launch torchelastic job on Kubernetes.
User needs to launch etcd, write pods and headless services and manage
pod lifecycle. A kubernetes <a class="reference external" href="https://coreos.com/operators/">operator</a>
can be introduced here to simplify the torchelastic job setups.
Underneath etcd and workers creation and destroy can be handled by
controller. Dynamic resource allocation and preemption can be added
later at this layer as well.</p>
</div>
</div>


             </article>
             
            </div>
            <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="checkpoint.html" class="btn btn-neutral float-right" title="Checkpoint" accesskey="n" rel="next">Next <img src="_static/images/chevron-right-orange.svg" class="next-page"></a>
      
      
        <a href="azure.html" class="btn btn-neutral" title="torchelastic on Azure" accesskey="p" rel="prev"><img src="_static/images/chevron-right-orange.svg" class="previous-page"> Previous</a>
      
    </div>
  

  

    <hr>

  

  <div role="contentinfo">
    <p>
        &copy; Copyright 2020, PyTorch Elastic Contributors.

    </p>
  </div>
    
      <div>
        Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>.
      </div>
     

</footer>

          </div>
        </div>

        <div class="pytorch-content-right" id="pytorch-content-right">
          <div class="pytorch-right-menu" id="pytorch-right-menu">
            <div class="pytorch-side-scroll" id="pytorch-side-scroll-right">
              <ul>
<li><a class="reference internal" href="#">torchelastic on Kubernetes</a><ul>
<li><a class="reference internal" href="#prerequisites">Prerequisites</a></li>
<li><a class="reference internal" href="#quickstart">Quickstart</a><ul>
<li><a class="reference internal" href="#create-kubernetes-cluster">Create Kubernetes cluster</a></li>
<li><a class="reference internal" href="#install-nvidia-device-plugin">Install Nvidia Device Plugin</a></li>
<li><a class="reference internal" href="#prepare-storage">Prepare storage</a><ul>
<li><a class="reference internal" href="#create-efs-and-mount-targets">Create EFS and mount targets</a></li>
<li><a class="reference internal" href="#install-efs-csi-driver">Install EFS CSI Driver</a></li>
<li><a class="reference internal" href="#create-persistentvolume-and-persistentvolumeclaim">Create PersistentVolume and PersistentVolumeClaim</a></li>
<li><a class="reference internal" href="#download-imagenet-dataset">Download imagenet dataset</a></li>
</ul>
</li>
<li><a class="reference internal" href="#lauch-etcd-instance">Lauch etcd instance</a></li>
<li><a class="reference internal" href="#launch-torchelastic-job">Launch torchelastic job</a><ul>
<li><a class="reference internal" href="#update-training-scripts-location">Update training scripts location</a></li>
<li><a class="reference internal" href="#attach-s3-access-to-eks-worker-nodes">Attach S3 access to EKS worker nodes</a></li>
<li><a class="reference internal" href="#create-workers">Create workers</a></li>
</ul>
</li>
<li><a class="reference internal" href="#check-worker-logs">Check worker logs</a></li>
<li><a class="reference internal" href="#clean-up-job">Clean up job</a></li>
</ul>
</li>
<li><a class="reference internal" href="#elasticity">Elasticity</a></li>
<li><a class="reference internal" href="#torchelastic-operator">torchelastic operator</a></li>
</ul>
</li>
</ul>

            </div>
          </div>
        </div>
      </section>
    </div>

  


  

     
       <script type="text/javascript" id="documentation_options" data-url_root="./" src="_static/documentation_options.js"></script>
         <script type="text/javascript" src="_static/jquery.js"></script>
         <script type="text/javascript" src="_static/underscore.js"></script>
         <script type="text/javascript" src="_static/doctools.js"></script>
         <script type="text/javascript" src="_static/language_data.js"></script>
         <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/katex@0.11.1/dist/katex.min.js"></script>
         <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/katex@0.11.1/dist/contrib/auto-render.min.js"></script>
         <script type="text/javascript" src="_static/katex_autorenderer.js"></script>
     

  

  <script type="text/javascript" src="_static/js/vendor/popper.min.js"></script>
  <script type="text/javascript" src="_static/js/vendor/bootstrap.min.js"></script>
  <script type="text/javascript" src="_static/js/theme.js"></script>

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

  <!-- Begin Footer -->

  <div class="container-fluid docs-tutorials-resources" id="docs-tutorials-resources">
    <div class="container">
      <div class="row">
        <div class="col-md-4 text-center">
          <h2>Docs</h2>
          <p>Access comprehensive developer documentation for PyTorch</p>
          <a class="with-right-arrow" href="https://pytorch.org/docs/stable/index.html">View Docs</a>
        </div>

        <div class="col-md-4 text-center">
          <h2>Tutorials</h2>
          <p>Get in-depth tutorials for beginners and advanced developers</p>
          <a class="with-right-arrow" href="https://pytorch.org/tutorials">View Tutorials</a>
        </div>

        <div class="col-md-4 text-center">
          <h2>Resources</h2>
          <p>Find development resources and get your questions answered</p>
          <a class="with-right-arrow" href="https://pytorch.org/resources">View Resources</a>
        </div>
      </div>
    </div>
  </div>

  <footer class="site-footer">
    <div class="container footer-container">
      <div class="footer-logo-wrapper">
        <a href="https://pytorch.org/" class="footer-logo"></a>
      </div>

      <div class="footer-links-wrapper">
        <div class="footer-links-col">
          <ul>
            <li class="list-title"><a href="https://pytorch.org/">PyTorch</a></li>
            <li><a href="https://pytorch.org/get-started">Get Started</a></li>
            <li><a href="https://pytorch.org/features">Features</a></li>
            <li><a href="https://pytorch.org/ecosystem">Ecosystem</a></li>
            <li><a href="https://pytorch.org/blog/">Blog</a></li>
            <li><a href="https://pytorch.org/resources">Resources</a></li>
          </ul>
        </div>

        <div class="footer-links-col">
          <ul>
            <li class="list-title"><a href="https://pytorch.org/support">Support</a></li>
            <li><a href="https://pytorch.org/tutorials">Tutorials</a></li>
            <li><a href="https://pytorch.org/docs/stable/index.html">Docs</a></li>
            <li><a href="https://discuss.pytorch.org" target="_blank">Discuss</a></li>
            <li><a href="https://github.com/pytorch/pytorch/issues" target="_blank">Github Issues</a></li>
            <li><a href="https://pytorch.slack.com" target="_blank">Slack</a></li>
            <li><a href="https://github.com/pytorch/pytorch/blob/master/CONTRIBUTING.md" target="_blank">Contributing</a></li>
          </ul>
        </div>

        <div class="footer-links-col follow-us-col">
          <ul>
            <li class="list-title">Follow Us</li>
            <li>
              <div id="mc_embed_signup">
                <form
                  action="https://twitter.us14.list-manage.com/subscribe/post?u=75419c71fe0a935e53dfa4a3f&id=91d0dccd39"
                  method="post"
                  id="mc-embedded-subscribe-form"
                  name="mc-embedded-subscribe-form"
                  class="email-subscribe-form validate"
                  target="_blank"
                  novalidate>
                  <div id="mc_embed_signup_scroll" class="email-subscribe-form-fields-wrapper">
                    <div class="mc-field-group">
                      <label for="mce-EMAIL" style="display:none;">Email Address</label>
                      <input type="email" value="" name="EMAIL" class="required email" id="mce-EMAIL" placeholder="Email Address">
                    </div>

                    <div id="mce-responses" class="clear">
                      <div class="response" id="mce-error-response" style="display:none"></div>
                      <div class="response" id="mce-success-response" style="display:none"></div>
                    </div>    <!-- real people should not fill this in and expect good things - do not remove this or risk form bot signups-->

                    <div style="position: absolute; left: -5000px;" aria-hidden="true"><input type="text" name="b_75419c71fe0a935e53dfa4a3f_91d0dccd39" tabindex="-1" value=""></div>

                    <div class="clear">
                      <input type="submit" value="" name="subscribe" id="mc-embedded-subscribe" class="button email-subscribe-button">
                    </div>
                  </div>
                </form>
              </div>

            </li>
          </ul>

          <div class="footer-social-icons">
            <a href="https://www.facebook.com/pytorch" target="_blank" class="facebook"></a>
            <a href="https://twitter.com/pytorch" target="_blank" class="twitter"></a>
          </div>
        </div>
      </div>
    </div>
  </footer>

  <div class="cookie-banner-wrapper">
  <div class="container">
    <p class="gdpr-notice">To analyze traffic and optimize your experience, we serve cookies on this site. By clicking or navigating, you agree to allow our usage of cookies. As the current maintainers of this site, Facebook’s Cookies Policy applies. Learn more, including about available controls: <a href="https://www.facebook.com/policies/cookies/">Cookies Policy</a>.</p>
    <img class="close-button" src="_static/images/pytorch-x.svg">
  </div>
</div>

  <!-- End Footer -->

  <!-- Begin Mobile Menu -->

  <div class="mobile-main-menu">
    <div class="container-fluid">
      <div class="container">
        <div class="mobile-main-menu-header-container">
          <a class="header-logo" href="https://pytorch.org/" aria-label="PyTorch"></a>
          <a class="main-menu-close-button" href="#" data-behavior="close-mobile-menu"></a>
        </div>
      </div>
    </div>

    <div class="mobile-main-menu-links-container">
      <div class="main-menu">
        <ul>
          <li>
            <a href="https://pytorch.org/get-started">Get Started</a>
          </li>

          <li>
            <a href="https://pytorch.org/features">Features</a>
          </li>

          <li>
            <a href="https://pytorch.org/ecosystem">Ecosystem</a>
          </li>

          <li>
            <a href="https://pytorch.org/mobile">Mobile</a>
          </li>

          <li>
            <a href="https://pytorch.org/hub">PyTorch Hub</a>
          </li>

          <li>
            <a href="https://pytorch.org/blog/">Blog</a>
          </li>

          <li>
            <a href="https://pytorch.org/tutorials">Tutorials</a>
          </li>

          <li>
            <a href="https://pytorch.org/docs/stable/index.html">Docs</a>
          </li>

          <li>
            <a href="https://pytorch.org/resources">Resources</a>
          </li>

          <li>
            <a href="https://github.com/pytorch/pytorch">Github</a>
          </li>
        </ul>
      </div>
    </div>
  </div>

  <!-- End Mobile Menu -->

  <script type="text/javascript" src="_static/js/vendor/anchor.min.js"></script>

  <script type="text/javascript">
    $(document).ready(function() {
      mobileMenu.bind();
      mobileTOC.bind();
      pytorchAnchors.bind();
      sideMenus.bind();
      scrollToAnchor.bind();
      highlightNavigation.bind();
      mainMenuDropdown.bind();

      // Add class to links that have code blocks, since we cannot create links in code blocks
      $("article.pytorch-article a span.pre").each(function(e) {
        $(this).closest("a").addClass("has-code");
      });
    })
  </script>
</body>
</html>